#!/bin/sh

revision="settrain v0.1.9 (2023-05-16 by MIB-Wiki)"
# use --help for more info

export PATH=:/proc/boot:/sbin:/bin:/usr/bin:/usr/sbin:/net/mmx/bin:/net/mmx/usr/bin:/net/mmx/usr/sbin:/net/mmx/sbin:/net/mmx/mnt/app/armle/bin:/net/mmx/mnt/app/armle/sbin:/net/mmx/mnt/app/armle/usr/bin:/net/mmx/mnt/app/armle/usr/sbin
export LD_LIBRARY_PATH=/net/mmx/mnt/app/root/lib-target:/net/mmx/mnt/eso/lib:/net/mmx/eso/lib:/net/mmx/mnt/app/usr/lib:/net/mmx/mnt/app/armle/lib:/net/mmx/mnt/app/armle/lib/dll:/net/mmx/mnt/app/armle/usr/lib
export IPL_CONFIG_DIR=/etc/eso/production

thisname="$(basename $0)"
thisdir="$(dirname $0)"

if [ -z $LOG ]; then
	. $thisdir/../config/GLOBALS
fi
echo -ne "$ME-$thisname---->\n" | $TEE -i -a $LOG

if [ -f $TMP/reboot.mib ]; then
	echo -ne "Aborted because the reboot is running...\n" | $TEE -a $LOG
	return 2> /dev/null
fi

if [ "$2" = "-noboot" ]; then
	noboot=$2
else
	noboot=""
fi

#Get the real train not from GLOBALS but from EEPROM as it can be changed already
TRAINVERSION="$($E2P r 3A0 19 | $SED -rn 's/^0x\S+\W+(.*?)$/\1/p' | $SED -rn 's:\W*(\S\S)\W*:0x\1\n:pg' | $SED -rn '/^0x/p' | $XXD -r -p | $SED 's/[^a-zA-Z0-9_-]//g' )"

case $1 in
	-eu) {
		trap '' 2
		echo -ne "Current train: $TRAINVERSION\n" | $TEE -i -a $LOG
		echo -ne ""
		TARGETTRAIN=""
		if [[ "$TRAINVERSION" = *ER* ]]; then
			echo -ne "Skipping. Your train is already EU!\n" | $TEE -i -a $LOG
		else
			echo -ne "Creating backup...\n" | $TEE -i -a $LOG
			echo -ne "Non EU train found, trying to find an EU match...\n" | $TEE -i -a $LOG
			. $thisdir/backup -a
			case $TRAINVERSION in
				MHI2Q_??_AUG22*)
					TARGETTRAIN="MHI2Q_ER_AUG22_P5092"
					$E2P w 3a0 4d 48 49 32 51 5f 45 52 5f 41 55 47 32 32 5f 50 >> $LOG
					$E2P w 3b0 35 30 39 32 00 >> $LOG
					;;
				MHI2_??_AUG22*)
					TARGETTRAIN="MHI2_ER_AUG22_K3346"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 41 55 47 32 32 5f 4b 33 >> $LOG
					$E2P w 3b0 33 34 36 00 00 >> $LOG
					;;
				*AU276*)
					TARGETTRAIN="MHI2_ER_AU276_P5088"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 41 55 32 37 36 5f 50 35 >> $LOG
					$E2P w 3b0 30 38 38 00 00 >> $LOG
					;;
				*AU37x*)
					TARGETTRAIN="MHI2_ER_AU37x_P5089"
					$E2P w 3a0 4D 48 49 32 5F 45 52 5F 41 55 33 37 78 5F 50 35 >> $LOG
					$E2P w 3b0 30 38 39 00 00 >> $LOG
					;;
				*AU43x*)
					TARGETTRAIN="MHI2_ER_AU43x_P5098"
					$E2P w 3a0 4D 48 49 32 5F 45 52 5F 41 55 34 33 78 5F 50 35 >> $LOG
					$E2P w 3b0 30 39 38 00 00 >> $LOG
					;;
				*AUG11*|*AU57x*)
					TARGETTRAIN="MHI2_ER_AU57x_K3663"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 41 55 35 37 78 5f 4b 33 >> $LOG
					$E2P w 3b0 36 36 33 00 00 >> $LOG
					;;
				*AU62x*)
					TARGETTRAIN="MHI2_ER_AU62x_P5099"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 41 55 36 32 78 5f 50 35 >> $LOG
					$E2P w 3b0 30 39 39 00 00 >> $LOG
					;;
				*POG11*)
					TARGETTRAIN="MHI2_ER_POG11_K5126"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 50 4f 47 31 31 5f 4b 35 >> $LOG
					$E2P w 3b0 31 32 36 00 00 >> $LOG
					;;
				*POG24*)
					TARGETTRAIN="MHI2_ER_POG24_K4224"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 50 4f 47 32 34 5f 4b 34 >> $LOG
					$E2P w 3b0 32 32 34 00 00 >> $LOG
					;;
				*SKG13*)
					TARGETTRAIN="MHI2_ER_SKG13_P4526"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 53 4b 47 31 33 5f 50 34 >> $LOG
					$E2P w 3b0 35 32 36 00 00 >> $LOG
					;;
				*VWG11*|*JP_VW270_?12*|*CN_VW48x_?06*|*JP_VW48x_?06*)
					TARGETTRAIN="MHI2_ER_VWG11_K3342"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 56 57 47 31 31 5f 4b 33 >> $LOG
					$E2P w 3b0 33 34 32 00 00 >> $LOG
					;;
				*VWG13*|*JP_VW48x_?07*|*CN_VW48x_?08*|*CN_VW48x_?09*|*CN_VW48x_?10*|*CN_VW48x_?11*|\
				*CN_VW48x_?12*|*JP_VW48x_?08*|*JP_VW48x_?09*|*JP_VW48x_?10*|*JP_VW48x_?11*|*JP_VW48x_?12*|\
				*TW_VW48x_?07*|*TW_VW48x_?09*|*TW_VW48x_?11*|*CN_VW511_?10*)
					TARGETTRAIN="MHI2_ER_VWG13_P4521"
					$E2P w 3a0 4d 48 49 32 5f 45 52 5f 56 57 47 31 33 5f 50 34 >> $LOG
					$E2P w 3b0 35 32 31 00 00 >> $LOG
					;;
				*)
					echo -ne "\nAborted. Unknown train!\nTo add support, upload backup to https://mibsolution.one M.I.B_Backup\n" | $TEE -i -a $LOG
					exit 1 ;;
			esac

			echo -ne "Changing train to $TARGETTRAIN\n" | $TEE -i -a $LOG
			#$E2P w 3a0 "$(echo $TARGETTRAIN | awk '{print substr($1,1,16)}' 2>/dev/null | $XXD -p | $SED 's/../& /g' | $SED 's/0a //')" >> $LOG
			#if [[ "$TARGETTRAIN" = *MHI2Q* ]]; then
			#	$E2P w 3b0 "$(echo $TARGETTRAIN | awk '{print substr($1,17,20)}' 2>/dev/null | $XXD -p | $SED 's/../& /g' | $SED 's/0a //')"00 >> $LOG
			#else
			#	$E2P w 3b0 "$(echo $TARGETTRAIN | awk '{print substr($1,17,19)}' 2>/dev/null | $XXD -p | $SED 's/../& /g' | $SED 's/0a //')"00 00 >> $LOG
			#fi
			echo -ne "Zeroing bytes 17 and 18 of 5F coding to avoid hang on the logo in EU fw\n" | $TEE -a $LOG
			if [[ "$TRAINVERSION" = *VW* ]] || [[ "$TRAINVERSION" = *SE* ]] || [[ "$TRAINVERSION" = *SK* ]]; then
				$PERSW -f -t int 0 1343767807 1 >> $LOG #skin=0 (byte 17 of 5F coding)
			else
				$PERSW -f -t int 0 1343767807 0 >> $LOG #skin=0 (byte 17 of 5F coding)
			fi
			$PERSW -f -t int 0 1343768831 0 >> $LOG #screen=0 (byte 18 of 5F coding)

			echo -ne "\n$thisname done!\n" | $TEE -i -a $LOG
		fi
	};;

	# help or unknown parameter ------------------------------
	*) {
		echo ""
		echo $revision
		echo ""
		echo "Usage: "$thisname" [OPTION] [-noboot]"
		echo ""
		echo "Options:"
		echo "        -eu           set Train to EU"
		echo "        --help        show this help"
		echo ""
		echo "Note: Backup will only work in RCC bash!"
		echo ""
		echo "This program is free software; you can redistribute it and/or"
		echo "modify it under the terms of the GNU General Public License"
		echo "as published by the Free Software Foundation; either version 2"
		echo "of the License, or (at your option) any later version."
		echo ""
		echo "This program is distributed in the hope that it will be useful,"
		echo "but WITHOUT ANY WARRANTY; without even the implied warranty of"
		echo "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
		echo "See the GNU General Public License for more details."
		echo ""
		echo "You should have received a copy of the GNU General Public License"
		echo "along with this program; if not, write to the Free Software Foundation,"
		echo "Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA."
		echo ""
	};;
esac

trap 2
[ -z "$noboot" ] && . $thisdir/reboot -t 10
exit 0